# 発注計算時の供給元判定ロジック

## 1. 現在の実装 (Phase 1/2) の判定ロジック

現在は「倉庫の役割（Hub/Satellite）」によって、供給元が **固定的に** 決定されています。動的な判別ロジック（商品ごとに変えるなど）は存在しません。

### A. Satellite倉庫の場合
*   **判定:** 全て **「親Hub倉庫からの移動」** と判定されます。
*   **ロジック:**
    1.  `WmsWarehouseAutoOrderSetting` テーブルで、自身の `warehouse_type` が `SATELLITE` であることを確認。
    2.  同テーブルの `hub_warehouse_id` カラムに設定された倉庫IDを、無条件で供給元（移動元）として使用します。
    3.  例外はなく、外部メーカーへの直接発注は行いません。

### B. Hub倉庫の場合
*   **判定:** 全て **「外部発注先（Contractor）からの仕入れ」** と判定されます。
*   **ロジック:**
    1.  `WmsWarehouseAutoOrderSetting` で `warehouse_type` が `HUB` であることを確認。
    2.  商品ごとの設定 `WmsItemOrderSetting` テーブルの `contractor_id` を参照し、そのサプライヤーを発注先とします。
    3.  他倉庫からの移動という選択肢はありません。

---

## 2. 新仕様 (Multi-Echelon) での変更点

新仕様では、上記の固定ルールを廃止し、**「商品×倉庫ごとの供給ルート設定」** に基づいて都度判定を行います。

### 判定ロジックの流れ (Step-by-Step)

発注計算バッチが「ある倉庫のある商品」の不足を検知した際、以下の手順で供給元を決定します。

1.  **供給ルート設定の取得:**
    *   計算対象の `warehouse_id` と `item_id` をキーにして、新設する **`wms_item_supply_settings`** テーブルを検索します。

2.  **`supply_type` カラムによる分岐:**
    *   このカラムの値が **`INTERNAL`** の場合:
        *   **→ 他倉庫からの移動** と判定。
        *   同レコードの `source_warehouse_id` を供給元倉庫とします。
    *   このカラムの値が **`EXTERNAL`** の場合:
        *   **→ 外部仕入れ** と判定。
        *   同レコードの `contractor_id` を発注先サプライヤーとします。

### まとめ比較

| 項目 | 現行 (Fixed) | 新仕様 (Multi-Echelon) |
| :--- | :--- | :--- |
| **判定基準** | 倉庫の役割 (`warehouse_type`) | 商品ごとの設定 (`wms_item_supply_settings`) |
| **Satellite** | 常に `hub_warehouse_id` から移動 | 設定次第で「A倉庫から移動」も「メーカー直発注」も可能 |
| **Hub** | 常に `contractor_id` へ発注 | 設定次第で「さらに上位のHubから移動」も可能 |
| **商品別の違い** | 不可（全商品同じルート） | 可能（冷凍はA倉庫から、常温はB倉庫から等） |
