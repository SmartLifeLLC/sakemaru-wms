# Android出荷作業端末向け API 仕様（概要版 / 既存WMSテーブル準拠）

---

## 1. 目的 / 対象範囲

* 倉庫出荷作業（ピッキング）に必要な **ログイン**、**倉庫選択**、**タスク取得**、**ピック実績登録**、**タスク完了**、**ログアウト
  ** を提供。
* **認証子**は `wms_pickers.code` とパスワード（暗号化保存）を使用。メールアドレスは使用しない。
* L5:swaggerを利用しAPI ドキュメントを作成する。
* url のprefixは /api

---

## 2. 関連テーブル（抜粋）

### 2.1 wms_pickers

* `id, code(Unique), name, password(hashed), default_warehouse_id, is_active, timestamps`

### 2.2 wms_picking_tasks

*
`id, wave_id, wms_picking_area_id, warehouse_id, warehouse_code, delivery_course_id, delivery_course_code, shipment_date, trade_id, status(PENDING|PICKING|COMPLETED), task_type(WAVE|REALLOCATION), picker_id, started_at, completed_at, timestamps`
* 代表インデックス: `(wave_id, wms_picking_area_id, status)`, `(wave_id, status)`, `(warehouse_code)`, `(delivery_course_code)`
* **変更点**:
  * `earning_id` 削除（伝票IDは `wms_picking_item_results` に移動）
  * `delivery_course_id`, `delivery_course_code` 追加（タスクを配送コース別にグループ化）
  * `warehouse_code` 追加（検索・フィルタリング用の非正規化カラム）
  * `shipment_date` 追加（出荷予定日）
  * `status` から `SHORTAGE` 削除（欠品追跡は item_results の `has_shortage` フラグで管理）

### 2.3 wms_picking_item_results

*
`id, picking_task_id, trade_item_id, item_id, real_stock_id, location_id, wms_picking_area_id, walking_order, ordered_qty, ordered_qty_type, planned_qty, planned_qty_type, picked_qty, picked_qty_type, shortage_qty, has_physical_shortage(generated), status(PICKING|COMPLETED|SHORTAGE), picked_at, picker_id, timestamps`
* 代表インデックス: `(wms_picking_area_id, walking_order, item_id)`, `(picking_task_id)`

> 並び順: 端末表示は **`wms_picking_area_id, walking_order, item_id`**
> を優先（歩行順最適化）。ピッキングエリア（常温/冷蔵/冷凍/フォークリフト）ごとにタスクが分割されます。

---

## 3. 認証 / セッション

* 認証方式: `POST /auth/login` でトークン発行（形式は実装側の標準: JWT など）。
* セッション終了: `POST /auth/logout`。
* 監査: ログイン/ログアウト時に `picker_id`, `device_id`, `timestamp` をログ記録。

### 3.1 エンドポイント

1. **ログイン** `POST /auth/login`

* 入力: `{ code, password, device_id? }`
* 成功: `{ token, picker: { id, code, name, default_warehouse_id } }`
* 失敗: 401（コード/パスワード不一致、`is_active=0`）

2. **ログアウト** `POST /auth/logout`

* 成功: 204

3. **自分情報** `GET /me`

* 成功: `{ id, code, name, default_warehouse_id }`

---

## 4. マスタ取得

> 既存の倉庫テーブルを利用（本仕様ではスキーマ省略）。

4. **倉庫一覧** `GET /warehouses`

* 出力: `[{ id, code, name }]`

5. **ピッキングエリア一覧** `GET /picking-areas?warehouse_id=...`

* 出力: `[{ id, code, name, warehouse_id }]`

> ※名称・フィールドは既存マスタに合わせる。端末は **`warehouse_id` を必須** とする前提。

---

## 5. ピッキングタスク

### 5.1 データ取得

6. **タスク一覧** `GET /picking/tasks`

* クエリ: `warehouse_id(required)`, `picker_id`, `picking_area_id`

* 戻り:配送コース別のピッキングリスト
    * 同じ配送コースには複数伝票のピッキングリストが来る。
    * 商品のピッキング順番はサーバで整理される。（商品ピッキングが最適化された順番でくる。）

#### picking_list アイテムのフィールド

| フィールド名 | 型 | 説明 |
|-------------|------|------|
| `wms_picking_item_result_id` | integer | ピッキング結果ID |
| `item_id` | integer | 商品ID |
| `item_name` | string | 商品名 |
| `jan_code` | string\|null | 代表JANコード（updated_atが最新のもの） |
| `jan_code_list` | array | 全JANコードリスト（updated_at降順） |
| `volume` | string\|null | 容量+単位（例: "720ml", "500g"） |
| `capacity_case` | integer\|null | 入り数（ケースあたりの個数） |
| `packaging` | string\|null | 規格（瓶、缶など） |
| `temperature_type` | string\|null | 温度帯（"常温", "定温", "冷蔵", "冷凍"） |
| `images` | array | 商品画像URLリスト（image_url_1, image_url_2, image_url_3のうち存在するもの） |
| `planned_qty_type` | string | 予定数量タイプ（CASE / PIECE） |
| `planned_qty` | string | 予定数量 |
| `picked_qty` | string | ピック済み数量 |
| `status` | string | ステータス（PENDING:開始前, PICKING:開始中, COMPLETED:完了, SHORTAGE:欠品） |
| `slip_number` | integer | 伝票番号（earning_id） |

#### ステータスの意味（wms_picking_item_results）

| status | 設定タイミング | 意味 |
|--------|--------------|------|
| PENDING | 初期状態 / cancel後 | 開始前（未着手） |
| PICKING | update呼び出し時 | ピッキング中（数量に関わらず常にPICKING） |
| COMPLETED | complete時（shortage_qty = 0） | 完了 |
| SHORTAGE | complete時（shortage_qty > 0） | 欠品あり |

#### ステータス遷移フロー

```
PENDING → PICKING（update呼び出し）→ COMPLETED/SHORTAGE（complete呼び出し）
    ↑         |
    +---------+（cancel呼び出し）
```

**重要**:
- update時は常に PICKING に設定（COMPLETED/SHORTAGEにはならない）
- complete時に全アイテムのstatusを最終判定（COMPLETED/SHORTAGE）
- PENDING/PICKINGが残っている状態ではcompleteできない

#### レスポンス例

```json
{
  "is_success": true,
  "code": "SUCCESS",
  "result": {
    "data": [
      {
        "course": {
          "code": "333",
          "name": "テストコース"
        },
        "picking_area": {
          "code": "123",
          "name": "PA-1"
        },
        "wave": {
          "wms_picking_task_id": 1,
          "wms_wave_id": 5
        },
        "picking_list": [
          {
            "wms_picking_item_result_id": 1,
            "item_id": 111110,
            "item_name": "白鶴特撰 本醸造生貯蔵酒720ml",
            "jan_code": "4901681115008",
            "jan_code_list": ["4901681115008", "4901681115015"],
            "volume": "720ml",
            "capacity_case": 12,
            "packaging": "瓶",
            "temperature_type": "常温",
            "images": ["https://example.com/items/111110/image1.jpg", "https://example.com/items/111110/image2.jpg"],
            "planned_qty_type": "CASE",
            "planned_qty": "2.00",
            "picked_qty": "0.00",
            "status": "PENDING",
            "slip_number": 1
          }
        ]
      }
    ]
  }
}
```

-- 同じアイテムでも伝票別のピッキングになることが必須

6-1. **単一タスク取得** `GET /picking/tasks/{wms_picking_task_id}`

* パラメータ: `wms_picking_task_id` (required) - ピッキングタスクID
* 戻り: 単一タスクの詳細（course, picking_area, wave, picking_list）
* レスポンス構造は一覧取得の1件分と同じ
* 失敗: 404（未検出）

```json
{
  "is_success": true,
  "code": "SUCCESS",
  "result": {
    "data": {
      "course": { "code": "333", "name": "テストコース" },
      "picking_area": { "code": "123", "name": "PA-1" },
      "wave": { "wms_picking_task_id": 1, "wms_wave_id": 5 },
      "picking_list": [...]
    }
  }
}
```

6-2. **単一アイテム取得** `GET /picking/items/{wms_picking_item_result_id}`

* パラメータ: `wms_picking_item_result_id` (required) - ピッキングアイテム結果ID
* 戻り: 単一アイテムの詳細（picking_listのアイテムと同じ構造）
* 失敗: 404（未検出）

```json
{
  "is_success": true,
  "code": "SUCCESS",
  "result": {
    "data": {
      "wms_picking_item_result_id": 178,
      "item_id": 158655,
      "item_name": "×ワインメーカーズ　ノート　シャルドネ　７５０ｍｌ",
      "jan_code": "9326817002732",
      "jan_code_list": ["9326817002732"],
      "volume": "750ml",
      "capacity_case": 12,
      "packaging": "750.0x12.0",
      "temperature_type": "定温",
      "images": [],
      "planned_qty_type": "CASE",
      "planned_qty": 6,
      "picked_qty": 0,
      "status": "PENDING",
      "slip_number": 39
    }
  }
}
```

### 5.2 タスク操作

7. **開始** `POST /picking/tasks/{wms_picking_task_id}/start`

* 作用: 該当wms_picking_task_idのwms_picking_tasksテーブルの状態をPICKINGに変更
* 成功: `{ is_success: true, result: { data: { id, status, started_at } } }`

8. **ピッキング数量登録** `POST /picking/tasks/{wms_picking_item_result_id}/update`

* 入力: `{ picked_qty, picked_qty_type? }`
* 作用:
    * wms_picking_item_resultsを更新（status は常に PICKING に設定）
    * **在庫更新はここでは行わない**（complete時に実施）
    * shortage_qty = planned_qty - picked_qty を計算
* 成功: `{ is_success: true, result: { data: { id, picked_qty, shortage_qty, status } } }`
* 失敗: 404（未検出）, 422（バリデーションエラー）

9. **ピッキングキャンセル** `POST /picking/tasks/{wms_picking_item_result_id}/cancel`

* 作用:
    * wms_picking_item_results.status を PENDING にリセット
    * picked_qty = 0, shortage_qty = 0 にリセット
* 成功: `{ is_success: true, result: { data: { id, picked_qty, shortage_qty, status } } }`
* 失敗: 404（未検出）, 422（COMPLETED/SHORTAGE状態はキャンセル不可）

10. **完了** `POST /picking/tasks/{wms_picking_task_id}/complete`

* 前提条件: 全ての wms_picking_item_results.status が PENDING または PICKING ではないこと
    * **PENDING/PICKING が残っている場合は完了不可（422エラー）**
* 作用:
    * 関連する wms_picking_item_results.status を更新:
        * shortage_qty > 0 の場合: SHORTAGE
        * shortage_qty = 0 の場合: COMPLETED
    * wms_picking_tasks.status を更新:
        * 1件でも SHORTAGE がある場合: SHORTAGE
        * 全て COMPLETED の場合: COMPLETED
    * **在庫更新を実施**: real_stocks の current_quantity, available_quantity, wms_reserved_qty を減算
* 成功: `{ is_success: true, result: { data: { id, status, completed_at } } }`
* 失敗: 404（未検出）, 422（未処理行あり）

---

## 6. バリデーション / ルール

* ログイン: `code` 必須、
* タスク取得: `warehouse_id` 必須。
* ピック登録:

    * `picked_qty > 0`（整数）
    * `picked_qty_type` は `planned_qty_type` に合致（相違時の換算はサーバ側定義がない限り不可）
    * 同時更新対策: 行にバージョン/ETag を付与し、競合時 409。
* 完了: 行に `PICKING` が残存する場合は 422（allow_short が真であれば `SHORTAGE` 完了可）。

---

## 7. エラーレスポンス（例）

基本的にはエラーもresponseを返す。

* `400` バリデーション: `{ message, errors: { field: [msg] } }`
* `401` 未認証 / 無効トークン
* `403` 権限不足
* `404` 未検出
* `409` 競合（割当済/並行更新/在庫予約の衝突）
* `422` 業務ルール違反（過剰/型不一致/未達完了禁止）
* `500` サーバエラー

---

